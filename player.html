<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KDRAMA Player</title>
  <style>
    /* === KDRAMA Player Custom Styles === */
    body { margin:0; font-family:Arial, sans-serif; background:#111; color:#fff; }
    .topbar { display:flex; justify-content:space-between; align-items:center;
      padding:12px; background:#000; }
    .branding { display:flex; align-items:center; gap:8px; }
    .branding span { background:#2a9df4; padding:6px 10px; border-radius:4px; font-weight:bold; }
    .channel { font-size:18px; font-weight:bold; }
    .btn { background:#222; padding:6px 10px; margin-left:6px; border:1px solid #333;
           border-radius:4px; cursor:pointer; color:#fff; text-decoration:none; display:inline-block; }
    .btn:hover { background:#333; }
    .video-container { max-width:950px; margin:20px auto; }
    .servers, .downloads { max-width:950px; margin:10px auto; }
    .servers button, .downloads button, .downloads a {
      margin:5px; padding:6px 12px; border-radius:6px; background:#333; color:#fff;
      border:none; cursor:pointer; text-decoration:none; display:inline-block;
    }
    .servers button:hover, .downloads button:hover, .downloads a:hover { background:#444; }
    .servers button.active { background:#2a9df4; }
    .downloads a { background:#2d5a2d; } /* Green tint for download buttons */
    .downloads a:hover { background:#3d6a3d; }
    .error { color:#f66; margin-top:6px; }
    .status { color:#4a9; margin:10px; }
    .server-count { color:#4a9; font-size:14px; margin:5px 0; }
    .warning { color:#ff9500; margin:10px; padding:8px; background:#2a1f0a; border-radius:4px; }
    #videoPlayer { width: 100%; height: 500px; }
  </style>
  <link href="https://vjs.zencdn.net/7.21.1/video-js.css" rel="stylesheet">
</head>
<body>
  <div class="topbar">
    <div class="branding">
      <span>üé¨</span>
      <div class="channel">KDRAMA Player</div>
    </div>
    <div class="utils">
      <button class="btn" onclick="openDirect()">Open Direct</button>
      <button class="btn" onclick="openVLC()">Play in VLC</button>
      <button class="btn" onclick="forceScrap()">Force Scrap</button>
      <button class="btn" onclick="refreshPage()">Refresh</button>
    </div>
  </div>

  <div class="video-container">
    <video id="videoPlayer" class="video-js vjs-default-skin" controls preload="auto" width="950" height="500"></video>
  </div>

  <div class="servers">
    <h3>Servers</h3>
    <div id="server-count" class="server-count"></div>
    <div id="servers"></div>
    <div id="status" class="status"></div>
    <div id="warning" class="warning" style="display:none;"></div>
  </div>

  <div class="downloads">
    <h3>Download</h3>
    <div id="downloads"></div>
  </div>

  <script src="https://vjs.zencdn.net/7.21.1/video.min.js"></script>
  <script>
    let currentLink = null;
    let player = null;

    async function loadEpisode() {
      try {
        const params = new URLSearchParams(window.location.search);
        const show = params.get("show");
        const ep = params.get("ep");

        if (!show || !ep) {
          document.getElementById("servers").innerText = "‚ùå Missing show/ep params";
          return;
        }

        document.getElementById("status").innerText = "Loading episode data...";

        const res = await fetch(`/get_link?show=${encodeURIComponent(show)}&ep=${encodeURIComponent(ep)}`);
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        let data = await res.json();
        console.log("Episode data (raw):", data);

        const serversDiv = document.getElementById("servers");
        const downloadsDiv = document.getElementById("downloads");
        const statusDiv = document.getElementById("status");
        const serverCountDiv = document.getElementById("server-count");
        const warningDiv = document.getElementById("warning");
        
        serversDiv.innerHTML = "";
        downloadsDiv.innerHTML = "";
        warningDiv.style.display = "none";

        // Handle server count and warnings
        if (data.server_info) {
            serverCountDiv.innerText = `Servers: ${data.server_info.server_count}/9`;
            
            if (data.server_info.needs_force_scrape) {
                warningDiv.innerText = data.server_info.message;
                warningDiv.style.display = "block";
            } else {
                warningDiv.style.display = "none";
            }
        }

        // Initialize player once
        if (!player) {
          player = videojs("videoPlayer", {
            fluid: true,
            responsive: true,
            playbackRates: [0.5, 1, 1.25, 1.5, 2]
          });
        }

        // Handle both cached and master responses
        let links = {};
        if (data.status === "cached" && data.links) {
          links = data.links;
          statusDiv.innerText = "‚úÖ Cached links loaded";
        } else if (data.status === "master" && data.links) {
          statusDiv.innerText = "‚ö†Ô∏è Only master links found. Click 'Force Scrap' to get direct links.";
          // Show master links as fallback
          for (const [quality, masterUrl] of Object.entries(data.links)) {
            const btn = document.createElement("button");
            btn.innerText = `${quality}p (Master)`;
            btn.onclick = () => {
              currentLink = masterUrl;
              player.src({ src: masterUrl, type: "video/mp4" });
              player.ready(() => {
                player.play();
              });
            };
            serversDiv.appendChild(btn);
          }
          return;
        } else {
          statusDiv.innerText = "‚ùå No links found";
          return;
        }

        console.log("Processing links:", links);

        let hasAnyServers = false;

        // Process cached links - CREATE BOTH SERVER AND DOWNLOAD BUTTONS FOR EACH SERVER
        for (const [quality, servers] of Object.entries(links)) {
          console.log(`Processing ${quality}:`, servers);
          
          if (!servers || typeof servers !== 'object') {
            console.log(`Skipping ${quality} - invalid servers data`);
            continue;
          }

          // Create server buttons (for playback)
          for (const [serverName, link] of Object.entries(servers)) {
            if (!link) continue;
            
            hasAnyServers = true;
            const btn = document.createElement("button");
            btn.innerText = `${quality}p (${serverName})`;
            btn.onclick = () => {
              // Remove active class from all buttons
              document.querySelectorAll('.servers button').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              
              currentLink = link;
              console.log("Playing:", link);
              
              player.src({ src: link, type: "video/mp4" });
              player.ready(() => {
                player.play().catch(e => {
                  console.error("Play error:", e);
                  statusDiv.innerText = "‚ùå Failed to play video. Try another server.";
                });
              });
            };
            serversDiv.appendChild(btn);
          }

          // Create download buttons (one for each server - SAME AS SERVER BUTTONS)
          for (const [serverName, link] of Object.entries(servers)) {
            if (!link) continue;
            
            const a = document.createElement("a");
            a.href = link;
            a.innerText = `${quality}p (${serverName})`;  // EXACTLY same text as server button
            a.className = "btn";
            a.setAttribute("download", "");
            a.target = "_blank";
            downloadsDiv.appendChild(a);
          }
        }

        if (hasAnyServers) {
          // Auto-play highest quality available
          const qualityOrder = ["1080", "720", "480"];
          for (const q of qualityOrder) {
            if (links[q] && Object.keys(links[q]).length > 0) {
              const firstServer = Object.values(links[q])[0];
              if (firstServer) {
                currentLink = firstServer;
                player.src({ src: firstServer, type: "video/mp4" });
                
                // Mark first button as active
                const firstBtn = serversDiv.querySelector('button');
                if (firstBtn) firstBtn.classList.add('active');
                
                console.log("Auto-playing:", firstServer);
                statusDiv.innerText = `‚úÖ Ready to play ${q}p`;
                break;
              }
            }
          }
        } else {
          statusDiv.innerText = "‚ùå No playable servers found";
        }

      } catch (err) {
        console.error("Load error:", err);
        document.getElementById("status").innerHTML = `‚ùå Error loading episode: ${err.message}`;
        document.getElementById("servers").innerHTML = `<div class="error">Failed to load episode data</div>`;
      }
    }

    function openDirect() {
      if (currentLink) {
        window.open(currentLink, "_blank");
      } else {
        alert("No video selected");
      }
    }

    function openVLC() {
      if (currentLink) {
        window.location.href = "vlc://" + currentLink;
      } else {
        alert("No video selected");
      }
    }

    async function forceScrap() {
      const params = new URLSearchParams(window.location.search);
      const show = params.get("show");
      const ep = params.get("ep");

      if (!show || !ep) {
        alert("Missing show/ep parameters");
        return;
      }

      document.getElementById("status").innerText = "üîÑ Scraping...";

      try {
        const res = await fetch(`/scrape?show=${encodeURIComponent(show)}&ep=${encodeURIComponent(ep)}`);
        const data = await res.json();
        console.log("Force scrape result:", data);

        if (data.status === "ok") {
          document.getElementById("status").innerText = "‚úÖ Scraping complete, reloading...";
          setTimeout(() => loadEpisode(), 1000); // reload with fresh cache
        } else {
          document.getElementById("status").innerText = "‚ùå Scraping failed";
          alert("Scraping failed: " + (data.message || "Unknown error"));
        }
      } catch (err) {
        console.error("Scrape error:", err);
        document.getElementById("status").innerText = "‚ùå Scraping error";
        alert("Scraping error: " + err.message);
      }
    }

    function refreshPage() {
      window.location.reload();
    }

    // Auto-run when page loads
    window.addEventListener('DOMContentLoaded', loadEpisode);
  </script>
</body>
</html>